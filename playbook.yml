---
- name: Minimal Ansible Playbook
  hosts: all
  tasks:
    - name: Get Git version info
      command: git --version
      register: git_version
      changed_when: false
      ignore_errors: true

    - name: Check if Git is Apple version
      set_fact:
        is_apple_git: "{{ 'Apple Git' in git_version.stdout }}"
      when: git_version.rc == 0

    - name: Update Xcode Command Line Tools (if Apple Git is present)
      command: xcode-select --install
      when: is_apple_git is defined and is_apple_git
      changed_when: false
      ignore_errors: true

    - name: Install Git using Homebrew (if no Git is present)
      homebrew:
        name: git
        state: latest
      when: git_version.rc != 0

    - name: Show Git status
      debug:
        msg: |
          Git status:
          {% if git_version.rc == 0 %}
          Version: {{ git_version.stdout }}
          {% if is_apple_git %}
          Type: Apple Git (updated via Xcode Command Line Tools)
          {% else %}
          Type: Homebrew Git
          {% endif %}
          {% else %}
          Git is not installed
          {% endif %}

    - name: Ensure Homebrew bin directory is in PATH
      lineinfile:
        path: ~/.zshrc
        line: 'export PATH="/opt/homebrew/bin:$PATH"'
        create: yes
      when: is_apple_git

    - name: Get updated Git path
      command: which git
      register: git_path
      changed_when: false

    - name: Show Git version
      debug:
        msg: "Using Git: {{ git_path.stdout }} ({{ git_version.stdout }})"

    - name: Example task
      debug:
        msg: "Hello from Ansible!"

    - name: Check if GitHub CLI is installed
      command: gh --version
      register: gh_version
      changed_when: false
      ignore_errors: true

    - name: Install GitHub CLI on macOS
      homebrew:
        name: gh
        state: latest
      when: ansible_os_family == "Darwin" and gh_version.rc != 0

    - name: Install GitHub CLI on Ubuntu
      block:
        - name: Install required packages
          apt:
            name: 
              - curl
              - gpg
            state: present
            
        - name: Download GitHub CLI GPG key
          get_url:
            url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
            dest: /usr/share/keyrings/githubcli-archive-keyring.gpg
            mode: '0644'

        - name: Add GitHub CLI apt repository
          apt_repository:
            repo: deb [arch=amd64 signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main
            state: present
            filename: github-cli

        - name: Install GitHub CLI
          apt:
            name: gh
            state: latest
            update_cache: yes
      when: ansible_os_family == "Debian" and gh_version.rc != 0
      become: true

    - name: Show GitHub CLI status
      debug:
        msg: |
          GitHub CLI status:
          {% if gh_version.rc == 0 %}
          Version: {{ gh_version.stdout }}
          {% else %}
          GitHub CLI has been installed. Please run 'gh auth login' to authenticate.
          {% endif %} 